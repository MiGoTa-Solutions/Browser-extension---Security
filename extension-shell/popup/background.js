import{l,G as g,c as x,b as h,a as y}from"./assets/logger-BnVZwszT.js";const O="http://127.0.0.1:4000/api",A=30*60*1e3;async function w(e){return new Promise(r=>{chrome.storage.local.set({auth_token:e},()=>{chrome.runtime.lastError?y("ExtensionBackground","Failed to persist auth token",{error:chrome.runtime.lastError.message}):l("ExtensionBackground","Stored auth token from Google login"),r()})})}function S(e,r={}){try{chrome.runtime.sendMessage({type:e,...r},()=>{chrome.runtime.lastError&&h("ExtensionBackground","No active listener for Google relay",{type:e,error:chrome.runtime.lastError.message})})}catch(o){y("ExtensionBackground","Failed to relay Google message",{type:e,error:o instanceof Error?o.message:"unknown_error"})}}function f(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function C(e,r){try{const o=await chrome.tabs.query({});for(const c of o){if(!c.id||!c.url||c.url.startsWith("chrome"))continue;const t=f(c.url);if(!t||r&&r.some(n=>t===n||t.endsWith("."+n)))continue;const i=e.find(n=>n.is_locked?t===n.url||t.endsWith("."+n.url):!1);if(i){l("ExtensionBackground","Force-locking active tab",{hostname:t,lockId:i.id});const n=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(c.url)}&id=${i.id}`;chrome.tabs.update(c.id,{url:n})}}}catch{}}async function d(){try{l("ExtensionBackground","Starting lock sync");const e=await chrome.storage.local.get(["auth_token","unlockedExceptions","lockedSites","exceptionExpiry"]),r=e.auth_token;if(!r){h("ExtensionBackground","Skipping sync, no auth token found"),E("?","#9ca3af");return}const o=await fetch(`${O}/locks`,{headers:{Authorization:`Bearer ${r}`}});if(o.status===401){h("ExtensionBackground","Sync failed due to unauthorized token"),E("!","#ef4444");return}if(o.ok){const t=(await o.json()).locks.map(s=>({...s,url:f(s.url)})),i=Date.now(),n=e.exceptionExpiry||{};let u=Array.isArray(e.unlockedExceptions)?e.unlockedExceptions:[];const a=u.filter(s=>{const p=n[s];return p?p>i:!0}),B=t.filter(s=>s.is_locked).map(s=>s.url),k=a.filter(s=>B.some(p=>s.includes(p))),m={};k.forEach(s=>{n[s]&&(m[s]=n[s])});const L=e.lockedSites||[];(JSON.stringify(t)!==JSON.stringify(L)||JSON.stringify(k)!==JSON.stringify(u))&&(await chrome.storage.local.set({lockedSites:t,unlockedExceptions:k,exceptionExpiry:m,lastSync:Date.now()}),l("ExtensionBackground","Synced lock cache",{lockCount:t.length,exceptionCount:k.length})),C(t,k),E("","")}}catch(e){y("ExtensionBackground","Lock sync failed",{error:e instanceof Error?e.message:"unknown_error"}),E("ERR","#f59e0b")}}function E(e,r){chrome.action.setBadgeText({text:e}),r&&chrome.action.setBadgeBackgroundColor({color:r})}async function _(e){if(e.frameId!==0||e.url.startsWith(chrome.runtime.getURL("")))return;const r=f(e.url);if(!r)return;const c=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};c[r]=(c[r]||0)+1,await chrome.storage.local.set({websiteFrequency:c});const t=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),i=t.lockedSites||[],n=Array.isArray(t.unlockedExceptions)?t.unlockedExceptions:[];if(!Array.isArray(i)||i.length===0||n.some(a=>r===a||r.endsWith("."+a)))return;const u=i.find(a=>a!=null&&a.is_locked?r===a.url||r.endsWith("."+a.url):!1);if(u){l("ExtensionBackground","Blocking navigation due to lock",{hostname:r,lockId:u.id});const a=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(e.url)}&id=${u.id}`;chrome.tabs.update(e.tabId,{url:a})}}chrome.webNavigation.onBeforeNavigate.addListener(_);chrome.webNavigation.onHistoryStateUpdated.addListener(_);chrome.runtime.onInstalled.addListener(()=>{l("ExtensionBackground","Extension installed/updated, priming sync"),d(),setInterval(d,5e3)});setInterval(d,5e3);chrome.runtime.onMessage.addListener((e,r,o)=>{if(e.type===g&&typeof e.token=="string")return w(e.token).then(()=>{d(),o({success:!0})}),!0;if(e.type===x)return h("ExtensionBackground","Received internal Google error",{error:e.error??"unknown_error"}),o({success:!0}),!0;if(e.type==="SYNC_LOCKS")return l("ExtensionBackground","Received SYNC_LOCKS message"),d().then(()=>o({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const c=e.url,t=f(c);if(t)return l("ExtensionBackground","Unlock request received",{hostname:t}),chrome.storage.local.get(["unlockedExceptions","exceptionExpiry"]).then(async i=>{const n=Array.isArray(i.unlockedExceptions)?i.unlockedExceptions:[],u=i.exceptionExpiry||{};n.includes(t)||n.push(t),u[t]=Date.now()+A,await chrome.storage.local.set({unlockedExceptions:n,exceptionExpiry:u}),o({success:!0})}),!0}if(e.type==="RELOCK_SITE"){const c=f(e.url);if(c)return l("ExtensionBackground","Relock request received",{hostname:c}),chrome.storage.local.get(["unlockedExceptions","exceptionExpiry"]).then(async t=>{let i=Array.isArray(t.unlockedExceptions)?t.unlockedExceptions:[],n=t.exceptionExpiry||{};i=i.filter(u=>u!==c),delete n[c],await chrome.storage.local.set({unlockedExceptions:i,exceptionExpiry:n}),o({success:!0})}),!0}});chrome.runtime.onMessageExternal.addListener((e,r,o)=>{if(e.type==="SYNC_LOCKS")return l("ExtensionBackground","Received external SYNC_LOCKS message"),d().then(()=>o({success:!0})),!0;if(e.type===g&&typeof e.token=="string")return l("ExtensionBackground","Received external Google token"),w(e.token).then(()=>{S(g,{token:e.token}),d(),o({success:!0})}),!0;if(e.type===x)return h("ExtensionBackground","Received external Google error",{error:e.error??"unknown_error"}),S(x,{error:e.error??"unknown_error"}),o({success:!0}),!0});
