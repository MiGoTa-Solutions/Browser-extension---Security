import{g as c,u as i}from"./assets/chromeStorage-BSHNbP9R.js";const a="http://localhost:4000/api";chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed. Scheduling sync."),chrome.alarms.create("sync_pulse",{periodInMinutes:1}),n()});chrome.alarms.onAlarm.addListener(e=>{e.name==="sync_pulse"&&n()});chrome.runtime.onMessage.addListener((e,s,r)=>{if(e.type==="UNLOCK_REQUEST")return u(e.lockId,e.pin).then(t=>r(t)),!0;if(e.type==="FORCE_SYNC")return n().then(()=>r({success:!0})),!0});async function n(){try{const e=await c();if(!e){console.log("[Background] No auth token. Skipping sync.");return}const r=await(await fetch(`${a}/locks`,{headers:{Authorization:`Bearer ${e}`}})).json();if(r.success&&Array.isArray(r.locks)){const t=await i(r.locks);console.log(`[Background] Synced successfully. Active rules: ${t.domainCount}`)}}catch(e){console.error("[Background] Sync failed:",e)}}async function u(e,s){try{const r=await c();if(!r)return{success:!1,error:"Not authenticated"};const o=await(await fetch(`${a}/locks/${e}/unlock`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({pin:s})})).json();return o.success?(await n(),{success:!0}):{success:!1,error:o.error||"Unlock failed"}}catch{return{success:!1,error:"Connection error"}}}
