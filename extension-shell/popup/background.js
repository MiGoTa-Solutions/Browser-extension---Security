const d="http://127.0.0.1:4000/api";function u(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function l(){try{const r=(await chrome.storage.local.get("auth_token")).auth_token;if(!r){i("?","#9ca3af");return}const t=await fetch(`${d}/locks`,{headers:{Authorization:`Bearer ${r}`}});if(t.status===401){console.warn("[Background] Auth Token Expired"),i("!","#ef4444");return}if(t.ok){const o=(await t.json()).locks.map(n=>({...n,url:u(n.url)}));await chrome.storage.local.set({lockedSites:o,lastSync:Date.now()}),i("",""),console.log(`[Background] Locks synced: ${o.length}`)}}catch{i("ERR","#f59e0b")}}function i(e,r){chrome.action.setBadgeText({text:e}),r&&chrome.action.setBadgeBackgroundColor({color:r})}async function g(e){try{if(!e||e.startsWith("chrome")||e==="newtab"||e==="extensions")return;const t=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};t[e]=(t[e]||0)+1,await chrome.storage.local.set({websiteFrequency:t})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0)return;const r=e.url;if(r.startsWith(chrome.runtime.getURL("")))return;let t;try{t=new URL(r).hostname.toLowerCase()}catch{return}g(t);const s=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),o=s.lockedSites||[],n=s.unlockedExceptions||[];if(!(!Array.isArray(o)||o.length===0))try{if(n.some(a=>t===a||t.endsWith("."+a))){console.log(`[Background] Allowing exception: ${t}`);return}const c=o.find(a=>!(a!=null&&a.is_locked)||!a.url?!1:t===a.url||t.endsWith("."+a.url));if(c){console.log(`[Background] Blocking ${t}`);const a=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(r)}&id=${c.id}`;chrome.tabs.update(e.tabId,{url:a})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed."),l(),setInterval(l,5e3)});setInterval(l,5e3);chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.type==="SYNC_LOCKS")return l().then(()=>t({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const s=e.url,o=u(s);if(o)return console.log(`[Background] Adding Exception: ${o}`),chrome.storage.local.get("unlockedExceptions").then(async n=>{try{const c=n.unlockedExceptions||[];c.includes(o)||(c.push(o),await chrome.storage.local.set({unlockedExceptions:c})),t({success:!0})}catch(c){console.error("[Background] Storage Write Error:",c),t({success:!1,error:"Storage write failed"})}}),!0}if(e.type==="RELOCK_SITE"){const s=u(e.url);if(s)return console.log(`[Background] Re-locking: ${s}`),chrome.storage.local.get("unlockedExceptions").then(async o=>{try{let n=o.unlockedExceptions||[];n=n.filter(c=>c!==s),await chrome.storage.local.set({unlockedExceptions:n}),t({success:!0})}catch(n){console.error("[Background] Storage Write Error:",n),t({success:!1})}}),!0}});chrome.runtime.onMessageExternal.addListener((e,r,t)=>{if(e.type==="SYNC_LOCKS")return console.log("[Background] External Sync Request Received"),l().then(()=>t({success:!0})),!0});
