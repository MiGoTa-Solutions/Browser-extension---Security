const i="http://127.0.0.1:4000/api";async function c(){try{const r=(await chrome.storage.local.get("auth_token")).auth_token;if(!r)return;const e=await fetch(`${i}/locks`,{headers:{Authorization:`Bearer ${r}`}});if(e.ok){const a=await e.json();await chrome.storage.local.set({lockedSites:a.locks,lastSync:Date.now()})}}catch(t){console.error("[Background] Sync failed:",t)}}async function u(t){try{const e=new URL(t).hostname;if(!e||e.startsWith("chrome")||e==="newtab")return;const o=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency??{};o[e]=(o[e]||0)+1,await chrome.storage.local.set({websiteFrequency:o})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async t=>{if(t.frameId!==0)return;const r=t.url;if(r.startsWith(chrome.runtime.getURL("")))return;u(r);const{lockedSites:e}=await chrome.storage.local.get("lockedSites");if(!(!Array.isArray(e)||e.length===0))try{const o=new URL(r).hostname.toLowerCase(),s=e.find(n=>n.is_locked&&o.includes(n.url.toLowerCase()));if(s){const n=chrome.runtime.getURL("lock.html")+`?url=${encodeURIComponent(r)}&id=${s.id}`;chrome.tabs.update(t.tabId,{url:n})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{c(),chrome.alarms.create("syncLocks",{periodInMinutes:5})});chrome.alarms.onAlarm.addListener(t=>{t.name==="syncLocks"&&c()});chrome.runtime.onMessage.addListener((t,r,e)=>{if(t.type==="SYNC_LOCKS")return c().then(()=>e({success:!0})),!0;t.type==="UNLOCK_SITE"&&e({success:!0})});
