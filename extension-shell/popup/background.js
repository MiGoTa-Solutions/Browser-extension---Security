const P="tab_lock_",b="locked_urls",y="lock_pin_map",r=(...t)=>console.log("[SecureShield]",...t);let u=new Map,m=new Map,v=!1;function $(t){if(!t)return null;try{const{hostname:e}=new URL(t);return e?e.replace(/^www\./,"").toLowerCase():null}catch{return t.toLowerCase()}}async function D(){return new Promise(t=>{chrome.storage.local.get([b,y],e=>{r("Loading from storage:",e),e[b]?(u=new Map,Object.entries(e[b]).forEach(([a,s])=>{const o=$(a);o&&u.set(o,Number(s))}),r(`Loaded ${u.size} locked hostnames from storage:`,Array.from(u.entries()))):r("No locked URLs found in storage"),e[y]?(m=new Map(Object.entries(e[y]).map(([a,s])=>[Number(a),s])),r(`Loaded ${m.size} PIN mappings from storage:`,Array.from(m.keys()))):r("No PIN mappings found in storage"),v=!0,t()})})}D();self.addEventListener("install",()=>{r("Service worker installed")});self.addEventListener("activate",()=>{r("Service worker activated")});chrome.tabs.onCreated.addListener(t=>{r("New tab created:",t.id,t.url),t.url&&t.id&&I(t.url)!==null&&r("üö´ New tab created for locked URL, will inject overlay when loaded:",t.url)});chrome.tabs.onUpdated.addListener(async(t,e,a)=>{if(e.status==="complete"&&a.url&&I(a.url)===null)try{const n=new URL(a.url).hostname,c=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};c[n]=(c[n]||0)+1,await chrome.storage.local.set({websiteFrequency:c}),r(`Visit count for ${n}: ${c[n]}`)}catch{}if(e.url){let s=I(e.url);s===null&&u.size>0&&(await E(),s=I(e.url)),s!==null&&r("üö´ URL changed to locked site, will inject overlay:",e.url)}});chrome.webNavigation.onBeforeNavigate.addListener(async t=>{if(t.frameId!==0)return;const e=t.url;let a=I(e);if(a===null&&u.size>0&&(await E(),a=I(e)),r(`Navigation check: ${e} -> Lock ID: ${a}, Total locked URLs: ${u.size}`),a!==null){const s=m.has(a);s&&m.get(a),r(`üîí Navigation to locked URL: ${e} (Lock ID: ${a}, Has PIN: ${s})`)}});chrome.runtime.onMessage.addListener((t,e,a)=>{const{action:s,payload:o}=t,n=d=>{d.then(c=>a({success:!0,data:c})).catch(c=>{r(`Action ${s} failed`,c.message),a({success:!1,error:c.message})})};switch(s){case"GET_CURRENT_TABS":n(M());break;case"GET_ACTIVE_TAB":n(K());break;case"GET_LOCKED_URLS":n(Promise.resolve(Array.from(u.keys())));break;case"CHECK_IF_LOCKED":{const i=o==null?void 0:o.url;if(i){const f=I(i),w=f!==null?m.get(f):void 0;a({success:!0,locked:f!==null,lockId:f||void 0,hasPin:f!==null?m.has(f):!1,pin:w})}else a({success:!1,error:"Missing URL"});return!1}case"VERIFY_PIN":{const{lockId:i,pin:f}=o||{};if(i===void 0||!f)return a({success:!1,error:"Missing lockId or PIN"}),!1;const w=m.get(i);return a({success:!0,valid:w?w===f:!0}),!1}case"LOCK_TABS":if(!(o!=null&&o.lockId)||!o.tabs)return a({success:!1,error:"Missing lockId or tabs"}),!1;n(B(o.lockId,o.tabs,o.pin,{skipClosingTabs:!!o.keepTabsOpen}));break;case"UNLOCK_TABS":if(!(o!=null&&o.lockId))return a({success:!1,error:"Missing lockId"}),!1;n(j(o.lockId).catch(i=>{r("Remote unlock failed, proceeding locally:",i.message)}).then(()=>F(o.lockId,o.pin)).then(async()=>{await E(!1,!0)}));break;case"SYNC_NOW":n(E());break;case"CHECK_DUPLICATE":if(!(o!=null&&o.url))return a({success:!1,error:"Missing URL"}),!1;const d=$(o.url),c=d?u.has(d):!1,h=c&&d?u.get(d):null;return a({success:!0,data:{isDuplicate:c,lockId:h,hostname:d}}),!1;case"CREATE_LOCK":if(!(o!=null&&o.token)||!o.data)return a({success:!1,error:"Missing token or data"}),!1;n(O(o.token,o.data).then(async i=>(await E(),i)));break;default:return a({success:!1,error:"Unknown action"}),!1}return!0});async function O(t,e){const a="http://localhost:4000/api";r("Creating lock via API:",{name:e.name,tabCount:e.tabs.length,hasToken:!!t});const s=[];for(const d of e.tabs){const c=$(d.url);if(c&&u.has(c)){const h=u.get(c);s.push(`${c} (Lock ID: ${h})`)}}if(s.length>0)throw r("‚ö†Ô∏è Duplicate domain(s) detected:",s),new Error(`This website is already locked. Please unlock it first before locking again.

Already locked: ${s.join(", ")}`);const o=await fetch(`${a}/locks`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(e)});if(r("API Response:",{status:o.status,ok:o.ok}),!o.ok){const d=await o.json().catch(()=>({message:"Failed to create lock"}));throw r("API Error:",d),new Error(d.message||"Failed to create lock")}const n=await o.json();return r("Lock created successfully:",n),n}async function j(t){const a=(await chrome.storage.local.get(["secureShield.auth"]))["secureShield.auth"];if(!(a!=null&&a.token)){r("‚ö†Ô∏è No auth token found; performing local-only unlock for lock",t);return}const s="http://localhost:4000/api";r(`Attempting remote unlock for lock ${t}`);const o=await fetch(`${s}/locks/${t}/unlock`,{method:"POST",headers:{Authorization:`Bearer ${a.token}`,"Content-Type":"application/json"}});if(!o.ok){const n=await o.json().catch(()=>({error:"Remote unlock failed"}));throw new Error(n.error||"Remote unlock failed")}r(`‚úÖ Remote unlock succeeded for lock ${t}`)}async function M(){return(await chrome.tabs.query({currentWindow:!0})).filter(e=>!!e.url&&!S(e.url)).map(e=>({title:e.title||new URL(e.url).hostname,url:e.url}))}async function K(){const e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!(e!=null&&e.url)||S(e.url))throw new Error("No active tab available for locking");return{title:e.title||new URL(e.url).hostname,url:e.url}}async function B(t,e,a,s){r(`Locking tabs for lock ${t} with${a?"":"out"} PIN`),r("Tabs to lock:",e);const o=await chrome.tabs.query({currentWindow:!0}),n=[],d=new Set,c=!(s!=null&&s.skipClosingTabs);a&&m.set(t,a);for(const L of e){const g=$(L.url);g&&(u.set(g,t),d.add(g),r(`Added to locked URLs: ${g} -> Lock ID ${t}`))}r(`Total locked URLs after update: ${u.size}`,Array.from(u.entries()));const h={[b]:Object.fromEntries(u),[y]:Object.fromEntries(m)};r("Data being stored:",h),await chrome.storage.local.set(h),r("Persisted to storage: locked URLs and PINs");const i=await chrome.storage.local.get([b,y]);if(r("Storage verification after write:",i),c)for(const L of o){if(!L.url||typeof L.id!="number")continue;const g=$(L.url);g&&d.has(g)&&n.push(L.id)}const f=`${P}${t}`,w={lockId:t,tabs:e,tabIds:n,timestamp:Date.now(),pin:a};await chrome.storage.local.set({[f]:w}),r(`Stored ${e.length} tab definitions (closing ${n.length})`),c&&n.length&&(await chrome.tabs.remove(n),r(`Closed ${n.length} tabs`))}async function F(t,e){r(`Unlocking tabs for lock ${t}`);const a=m.get(t);if(a&&a!==e)throw new Error("Invalid PIN");const s=`${P}${t}`,n=(await chrome.storage.local.get(s))[s];if(!n){r(`No stored state found for lock ${t}`);return}const d=new Set;for(const h of n.tabs){const i=$(h.url);i&&(u.delete(i),d.add(i))}m.delete(t),await chrome.storage.local.set({[b]:Object.fromEntries(u),[y]:Object.fromEntries(m)});const c=await chrome.tabs.query({});for(const h of c)if(h.url&&h.id){const i=$(h.url);i&&d.has(i)&&chrome.tabs.reload(h.id).catch(f=>r("Failed to reload tab:",f))}for(const h of n.tabs)try{await chrome.tabs.create({url:h.url,active:!1})}catch(i){r(`Failed to reopen tab ${h.url}`,i)}await chrome.storage.local.remove(s),r(`Cleared stored state for lock ${t}`)}function S(t){return t.startsWith("chrome://")||t.startsWith("chrome-extension://")||t.startsWith("about:")}let U=0;const _=3,W=2e3;let T=!1,N=0;const Y=3e4;async function E(t=!1,e=!1){var a;try{const o=(await chrome.storage.local.get(["secureShield.auth"]))["secureShield.auth"];if(!(o!=null&&o.token)){const l=Date.now();if(T||(r("No auth token found, skipping database sync"),T=!0),!e&&l-N<Y)return;N=l;return}T=!1,N=0,r(`Syncing locks from database... ${t?`(Retry ${U}/${_})`:""}`);const n=new AbortController,d=setTimeout(()=>n.abort(),5e3),c=await fetch("http://localhost:4000/api/locks",{headers:{Authorization:`Bearer ${o.token}`,"Content-Type":"application/json"},signal:n.signal});if(clearTimeout(d),!c.ok)throw new Error(`Sync failed with status: ${c.status}`);const i=(await c.json()).locks||[];r(`Database returned ${i.length} locks`);const f=await chrome.storage.local.get([b,y]),w=new Map,L=new Map;f[b]&&Object.entries(f[b]).forEach(([l,p])=>{w.set(l,Number(p))}),f[y]&&Object.entries(f[y]).forEach(([l,p])=>{L.set(Number(l),p)}),r(`Current local locks: ${w.size} URLs, ${L.size} PINs`);const g=new Map(w),A=new Map(L);i.forEach(l=>{var p;r(`Processing lock ${l.id}: status=${l.status}, tabs=${((p=l.tabs)==null?void 0:p.length)||0}`),l.status==="locked"&&Array.isArray(l.tabs)&&l.tabs.forEach(C=>{const k=$(C.url);k&&(g.has(k)?r(`‚ö†Ô∏è Duplicate URL detected: ${k} (existing Lock ID: ${g.get(k)}, new Lock ID: ${l.id})`):(g.set(k,l.id),r(`Added from database: ${k} -> Lock ID ${l.id}`)))}),l.status==="unlocked"&&Array.isArray(l.tabs)&&(l.tabs.forEach(C=>{const k=$(C.url);k&&g.get(k)===l.id&&(g.delete(k),r(`Removed unlocked URL from local: ${k}`))}),A.has(l.id)&&(A.delete(l.id),r(`Removed PIN for unlocked lock ${l.id}`)))}),u=g,m=A;const R=Object.fromEntries(u.entries()),z=Object.fromEntries(m.entries());await chrome.storage.local.set({[b]:R,[y]:z}),r(`‚úÖ Synced and merged: ${u.size} locked URLs, ${m.size} PINs`),U=0}catch(s){if(r("‚ùå Error syncing locks from database:",s),U<_){U++;const o=W*U;r(`Retrying sync in ${o}ms...`),setTimeout(()=>E(!0),o)}else r("‚ö†Ô∏è Max sync retries reached. Using cached lock data."),U=0,(a=chrome.notifications)==null||a.create({type:"basic",iconUrl:"icons/icon48.png",title:"SecureShield Sync Warning",message:"Unable to sync locks from server. Using cached data."}).catch(()=>{})}}E(!1,!0);setInterval(()=>E(),3e4);chrome.storage.onChanged.addListener((t,e)=>{e==="local"&&t[b]&&(r("Locked URLs changed in storage, syncing..."),E())});function I(t){if(S(t))return null;if(!v)return r("‚ö†Ô∏è Storage not yet initialized, deferring lock check"),null;const e=$(t);return e&&u.get(e)||null}
