const C="tab_lock_",k="locked_urls",L="lock_pin_map",r=(...e)=>console.log("[SecureShield]",...e);let u=new Map,f=new Map;function b(e){if(!e)return null;try{const{hostname:t}=new URL(e);return t?t.replace(/^www\./,"").toLowerCase():null}catch{return e.toLowerCase()}}chrome.storage.local.get([k,L],e=>{r("Loading from storage:",e),e[k]?(u=new Map,Object.entries(e[k]).forEach(([t,o])=>{const a=b(t);a&&u.set(a,Number(o))}),r(`Loaded ${u.size} locked hostnames from storage`)):r("No locked URLs found in storage"),e[L]?(f=new Map(Object.entries(e[L]).map(([t,o])=>[Number(t),o])),r(`Loaded ${f.size} PIN mappings from storage`)):r("No PIN mappings found in storage")});self.addEventListener("install",()=>{r("Service worker installed")});self.addEventListener("activate",()=>{r("Service worker activated")});chrome.tabs.onCreated.addListener(e=>{r("New tab created:",e.id,e.url),e.url&&e.id&&w(e.url)!==null&&r("üö´ New tab created for locked URL, will inject overlay when loaded:",e.url)});chrome.tabs.onUpdated.addListener(async(e,t,o)=>{if(t.status==="complete"&&o.url&&w(o.url)===null)try{const n=new URL(o.url).hostname,c=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};c[n]=(c[n]||0)+1,await chrome.storage.local.set({websiteFrequency:c}),r(`Visit count for ${n}: ${c[n]}`)}catch{}if(t.url){let a=w(t.url);a===null&&(await g(),a=w(t.url)),a!==null&&r("üö´ URL changed to locked site, will inject overlay:",t.url)}});chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0)return;const t=e.url;let o=w(t);if(o===null&&(await g(),o=w(t)),r(`Navigation check: ${t} -> Lock ID: ${o}, Total locked URLs: ${u.size}`),o!==null){const a=f.has(o);a&&f.get(o),r(`üîí Navigation to locked URL: ${t} (Lock ID: ${o}, Has PIN: ${a})`)}});chrome.runtime.onMessage.addListener((e,t,o)=>{const{action:a,payload:s}=e,n=i=>{i.then(c=>o({success:!0,data:c})).catch(c=>{r(`Action ${a} failed`,c.message),o({success:!1,error:c.message})})};switch(a){case"GET_CURRENT_TABS":n(v());break;case"GET_ACTIVE_TAB":n(S());break;case"GET_LOCKED_URLS":n(Promise.resolve(Array.from(u.keys())));break;case"CHECK_IF_LOCKED":{const i=s==null?void 0:s.url;if(i){const c=w(i),l=c!==null?f.get(c):void 0;o({success:!0,locked:c!==null,lockId:c||void 0,hasPin:c!==null?f.has(c):!1,pin:l})}else o({success:!1,error:"Missing URL"});return!1}case"VERIFY_PIN":{const{lockId:i,pin:c}=s||{};if(i===void 0||!c)return o({success:!1,error:"Missing lockId or PIN"}),!1;const l=f.get(i);return o({success:!0,valid:l?l===c:!0}),!1}case"LOCK_TABS":if(!(s!=null&&s.lockId)||!s.tabs)return o({success:!1,error:"Missing lockId or tabs"}),!1;n(p(s.lockId,s.tabs,s.pin,{skipClosingTabs:!!s.keepTabsOpen}));break;case"UNLOCK_TABS":if(!(s!=null&&s.lockId))return o({success:!1,error:"Missing lockId"}),!1;n(N(s.lockId,s.pin).then(async()=>{await g()}));break;case"SYNC_NOW":n(g());break;case"CREATE_LOCK":if(!(s!=null&&s.token)||!s.data)return o({success:!1,error:"Missing token or data"}),!1;n(_(s.token,s.data).then(async i=>(await g(),i)));break;default:return o({success:!1,error:"Unknown action"}),!1}return!0});async function _(e,t){const o="http://localhost:4000/api";r("Creating lock via API:",{name:t.name,tabCount:t.tabs.length,hasToken:!!e});const a=await fetch(`${o}/locks`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(t)});if(r("API Response:",{status:a.status,ok:a.ok}),!a.ok){const n=await a.json().catch(()=>({message:"Failed to create lock"}));throw r("API Error:",n),new Error(n.message||"Failed to create lock")}const s=await a.json();return r("Lock created successfully:",s),s}async function v(){return(await chrome.tabs.query({currentWindow:!0})).filter(t=>!!t.url&&!T(t.url)).map(t=>({title:t.title||new URL(t.url).hostname,url:t.url}))}async function S(){const t=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!(t!=null&&t.url)||T(t.url))throw new Error("No active tab available for locking");return{title:t.title||new URL(t.url).hostname,url:t.url}}async function p(e,t,o,a){r(`Locking tabs for lock ${e} with${o?"":"out"} PIN`),r("Tabs to lock:",t);const s=await chrome.tabs.query({currentWindow:!0}),n=[],i=new Set,c=!(a!=null&&a.skipClosingTabs);o&&f.set(e,o);for(const h of t){const m=b(h.url);m&&(u.set(m,e),i.add(m),r(`Added to locked URLs: ${m} -> Lock ID ${e}`))}r(`Total locked URLs after update: ${u.size}`,Array.from(u.entries()));const l={[k]:Object.fromEntries(u),[L]:Object.fromEntries(f)};r("Data being stored:",l),await chrome.storage.local.set(l),r("Persisted to storage: locked URLs and PINs");const d=await chrome.storage.local.get([k,L]);if(r("Storage verification after write:",d),c)for(const h of s){if(!h.url||typeof h.id!="number")continue;const m=b(h.url);m&&i.has(m)&&n.push(h.id)}const E=`${C}${e}`,$={lockId:e,tabs:t,tabIds:n,timestamp:Date.now(),pin:o};await chrome.storage.local.set({[E]:$}),r(`Stored ${t.length} tab definitions (closing ${n.length})`),c&&n.length&&(await chrome.tabs.remove(n),r(`Closed ${n.length} tabs`))}async function N(e,t){r(`Unlocking tabs for lock ${e}`);const o=f.get(e);if(o&&o!==t)throw new Error("Invalid PIN");const a=`${C}${e}`,n=(await chrome.storage.local.get(a))[a];if(!n){r(`No stored state found for lock ${e}`);return}const i=new Set;for(const l of n.tabs){const d=b(l.url);d&&(u.delete(d),i.add(d))}f.delete(e),await chrome.storage.local.set({[k]:Object.fromEntries(u),[L]:Object.fromEntries(f)});const c=await chrome.tabs.query({});for(const l of c)if(l.url&&l.id){const d=b(l.url);d&&i.has(d)&&chrome.tabs.reload(l.id).catch(E=>r("Failed to reload tab:",E))}for(const l of n.tabs)try{await chrome.tabs.create({url:l.url,active:!1})}catch(d){r(`Failed to reopen tab ${l.url}`,d)}await chrome.storage.local.remove(a),r(`Cleared stored state for lock ${e}`)}function T(e){return e.startsWith("chrome://")||e.startsWith("chrome-extension://")||e.startsWith("about:")}let y=0;const U=3,A=2e3;async function g(e=!1){var t;try{const a=(await chrome.storage.local.get(["secureShield.auth"]))["secureShield.auth"];if(!(a!=null&&a.token)){r("No auth token found, skipping database sync");return}r(`Syncing locks from database... ${e?`(Retry ${y}/${U})`:""}`);const s=new AbortController,n=setTimeout(()=>s.abort(),5e3),i=await fetch("http://localhost:4000/api/locks",{headers:{Authorization:`Bearer ${a.token}`,"Content-Type":"application/json"},signal:s.signal});if(clearTimeout(n),!i.ok)throw new Error(`Sync failed with status: ${i.status}`);const l=(await i.json()).locks||[],d=new Map,E=new Map;l.forEach(h=>{h.status==="locked"&&Array.isArray(h.tabs)&&h.tabs.forEach(m=>{const I=b(m.url);I&&d.set(I,h.id)})}),u=d;const $=Object.fromEntries(u.entries());await chrome.storage.local.set({[k]:$}),r(`‚úÖ Synced ${u.size} locked URLs from database`),y=0}catch(o){if(r("‚ùå Error syncing locks from database:",o),y<U){y++;const a=A*y;r(`Retrying sync in ${a}ms...`),setTimeout(()=>g(!0),a)}else r("‚ö†Ô∏è Max sync retries reached. Using cached lock data."),y=0,(t=chrome.notifications)==null||t.create({type:"basic",iconUrl:"icons/icon48.png",title:"SecureShield Sync Warning",message:"Unable to sync locks from server. Using cached data."}).catch(()=>{})}}g();setInterval(g,5e3);chrome.storage.onChanged.addListener((e,t)=>{t==="local"&&e[k]&&(r("Locked URLs changed in storage, syncing..."),g())});function w(e){if(T(e))return null;const t=b(e);return t&&u.get(t)||null}
