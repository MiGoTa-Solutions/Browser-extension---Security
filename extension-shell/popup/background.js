const h="http://127.0.0.1:4000/api";function m(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function a(){try{const n=(await chrome.storage.local.get("auth_token")).auth_token;if(!n)return;const t=await fetch(`${h}/locks`,{headers:{Authorization:`Bearer ${n}`}});if(t.ok){const r=await t.json();await chrome.storage.local.set({lockedSites:r.locks,lastSync:Date.now()}),console.log("[Background] Locks synced:",r.locks.length)}}catch(e){console.error("[Background] Sync failed:",e)}}async function g(e){try{const t=new URL(e).hostname;if(!t||t.startsWith("chrome")||t==="newtab"||t==="extensions")return;const o=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};o[t]=(o[t]||0)+1,await chrome.storage.local.set({websiteFrequency:o})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0)return;const n=e.url;if(n.startsWith(chrome.runtime.getURL("")))return;g(n);const{lockedSites:t}=await chrome.storage.local.get("lockedSites");if(!(!Array.isArray(t)||t.length===0))try{const o=new URL(n).hostname.toLowerCase();if(((await chrome.storage.session.get("tempUnlocked")).tempUnlocked||[]).some(s=>o.includes(s))){console.log(`[Background] Allowing temporarily unlocked site: ${o}`);return}const l=t.find(s=>{if(!(s!=null&&s.is_locked))return!1;const u=m(s.url);return u?o.includes(u):!1});if(l){console.log(`[Background] Blocking ${o}`);const s=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(n)}&id=${l.id}`;chrome.tabs.update(e.tabId,{url:s})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed. Starting sync alarm."),a(),chrome.alarms.create("syncLocks",{periodInMinutes:5}),chrome.storage.session.set({tempUnlocked:[]})});chrome.alarms.onAlarm.addListener(e=>{e.name==="syncLocks"&&a()});chrome.runtime.onMessage.addListener((e,n,t)=>{if(e.type==="SYNC_LOCKS")return a().then(()=>t({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const r=e.url,o=m(r);if(o)return console.log(`[Background] Unlocking ${o} temporarily`),chrome.storage.session.get("tempUnlocked").then(i=>{const c=i.tempUnlocked||[];c.includes(o)||(c.push(o),chrome.storage.session.set({tempUnlocked:c})),t({success:!0})}),!0}});
