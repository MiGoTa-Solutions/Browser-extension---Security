const g="http://127.0.0.1:4000/api";function d(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function l(){try{const o=(await chrome.storage.local.get("auth_token")).auth_token;if(!o){i("?","#9ca3af");return}const t=await fetch(`${g}/locks`,{headers:{Authorization:`Bearer ${o}`}});if(t.status===401){console.warn("[Background] Auth Token Expired"),i("!","#ef4444");return}if(t.ok){const n=await t.json();await chrome.storage.local.set({lockedSites:n.locks,lastSync:Date.now()}),i("",""),console.log(`[Background] Locks synced: ${n.locks.length}`)}}catch{i("ERR","#f59e0b")}}function i(e,o){chrome.action.setBadgeText({text:e}),o&&chrome.action.setBadgeBackgroundColor({color:o})}async function k(e){try{const t=new URL(e).hostname;if(!t||t.startsWith("chrome")||t==="newtab"||t==="extensions")return;const r=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};r[t]=(r[t]||0)+1,await chrome.storage.local.set({websiteFrequency:r})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0)return;const o=e.url;if(o.startsWith(chrome.runtime.getURL("")))return;k(o);const t=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),n=t.lockedSites||[],r=t.unlockedExceptions||[];if(!(!Array.isArray(n)||n.length===0))try{const c=new URL(o).hostname.toLowerCase();if(r.some(s=>c===s||c.endsWith("."+s))){console.log(`[Background] Allowing exception: ${c}`);return}const h=n.find(s=>{if(!(s!=null&&s.is_locked))return!1;const u=d(s.url);return u?c===u||c.endsWith("."+u):!1});if(h){console.log(`[Background] Blocking ${c}`);const s=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(o)}&id=${h.id}`;chrome.tabs.update(e.tabId,{url:s})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed."),l(),setInterval(l,5e3)});setInterval(l,5e3);chrome.runtime.onMessage.addListener((e,o,t)=>{if(e.type==="SYNC_LOCKS")return l().then(()=>t({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const n=e.url,r=d(n);if(r)return console.log(`[Background] Adding Exception: ${r}`),chrome.storage.local.get("unlockedExceptions").then(async a=>{const c=a.unlockedExceptions||[];c.includes(r)||(c.push(r),await chrome.storage.local.set({unlockedExceptions:c})),t({success:!0})}),!0}if(e.type==="RELOCK_SITE"){const n=d(e.url);if(n)return console.log(`[Background] Re-locking: ${n}`),chrome.storage.local.get("unlockedExceptions").then(async r=>{let a=r.unlockedExceptions||[];a=a.filter(c=>c!==n),await chrome.storage.local.set({unlockedExceptions:a}),t({success:!0})}),!0}});chrome.runtime.onMessageExternal.addListener((e,o,t)=>{if(e.type==="SYNC_LOCKS")return console.log("[Background] External Sync Request Received"),l().then(()=>t({success:!0})),!0});
