const f="http://127.0.0.1:4000/api";function d(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function u(){try{const e=await chrome.storage.local.get(["auth_token","unlockedExceptions"]),n=e.auth_token;if(!n){l("?","#9ca3af");return}const t=await fetch(`${f}/locks`,{headers:{Authorization:`Bearer ${n}`}});if(t.status===401){l("!","#ef4444");return}if(t.ok){const r=(await t.json()).locks.map(i=>({...i,url:d(i.url)}));let s=e.unlockedExceptions||[];const c=r.filter(i=>i.is_locked).map(i=>i.url),o=s.filter(i=>c.some(h=>i.includes(h)));await chrome.storage.local.set({lockedSites:r,unlockedExceptions:o,lastSync:Date.now()}),l("",""),console.log(`[Background] Synced. Active Locks: ${r.length}`)}}catch{l("ERR","#f59e0b")}}function l(e,n){chrome.action.setBadgeText({text:e}),n&&chrome.action.setBadgeBackgroundColor({color:n})}async function p(e){try{if(!e||e.startsWith("chrome")||e==="newtab"||e==="extensions")return;const t=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};t[e]=(t[e]||0)+1,await chrome.storage.local.set({websiteFrequency:t})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0)return;const n=e.url;if(n.startsWith(chrome.runtime.getURL("")))return;let t;try{t=new URL(n).hostname.toLowerCase()}catch{return}p(t);const a=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),r=a.lockedSites||[],s=a.unlockedExceptions||[];if(!(!Array.isArray(r)||r.length===0))try{if(s.some(o=>t===o||t.endsWith("."+o))){console.log(`[Background] Allowing exception: ${t}`);return}const c=r.find(o=>!(o!=null&&o.is_locked)||!o.url?!1:t===o.url||t.endsWith("."+o.url));if(c){console.log(`[Background] Blocking ${t}`);const o=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(n)}&id=${c.id}`;chrome.tabs.update(e.tabId,{url:o})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{u(),setInterval(u,5e3)});setInterval(u,5e3);chrome.runtime.onMessage.addListener((e,n,t)=>{if(e.type==="SYNC_LOCKS")return u().then(()=>t({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const a=e.url,r=d(a);if(r)return chrome.storage.local.get("unlockedExceptions").then(async s=>{const c=s.unlockedExceptions||[];c.includes(r)||(c.push(r),await chrome.storage.local.set({unlockedExceptions:c})),t({success:!0})}),!0}if(e.type==="RELOCK_SITE"){const a=d(e.url);if(a)return chrome.storage.local.get("unlockedExceptions").then(async r=>{let s=r.unlockedExceptions||[];s=s.filter(c=>c!==a),await chrome.storage.local.set({unlockedExceptions:s}),t({success:!0})}),!0}});chrome.runtime.onMessageExternal.addListener((e,n,t)=>{if(e.type==="SYNC_LOCKS")return u().then(()=>t({success:!0})),!0});
