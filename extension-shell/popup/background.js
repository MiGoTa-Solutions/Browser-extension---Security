const g="http://127.0.0.1:4000/api";function l(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function p(e,n){try{const s=await chrome.tabs.query({});for(const r of s){if(!r.id||!r.url||r.url.startsWith("chrome"))continue;const t=l(r.url);if(!t||n.some(o=>t===o||t.endsWith("."+o)))continue;const c=e.find(o=>o.is_locked?t===o.url||t.endsWith("."+o.url):!1);if(c){console.log(`[Background] Force-locking active tab: ${t}`);const o=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(r.url)}&id=${c.id}`;chrome.tabs.update(r.id,{url:o})}}}catch{}}async function d(){try{const e=await chrome.storage.local.get(["auth_token","unlockedExceptions","lockedSites"]),n=e.auth_token;if(!n){h("?","#9ca3af");return}const s=await fetch(`${g}/locks`,{headers:{Authorization:`Bearer ${n}`}});if(s.status===401){h("!","#ef4444");return}if(s.ok){const t=(await s.json()).locks.map(i=>({...i,url:l(i.url)}));let c=e.unlockedExceptions||[];const o=t.filter(i=>i.is_locked).map(i=>i.url),u=c.filter(i=>o.some(m=>i.includes(m))),a=e.lockedSites||[];(JSON.stringify(t)!==JSON.stringify(a)||JSON.stringify(u)!==JSON.stringify(c))&&await chrome.storage.local.set({lockedSites:t,unlockedExceptions:u,lastSync:Date.now()}),p(t,u),h("","")}}catch{h("ERR","#f59e0b")}}function h(e,n){chrome.action.setBadgeText({text:e}),n&&chrome.action.setBadgeBackgroundColor({color:n})}async function f(e){if(e.frameId!==0||e.url.startsWith(chrome.runtime.getURL("")))return;const n=l(e.url);if(!n)return;const r=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};r[n]=(r[n]||0)+1,await chrome.storage.local.set({websiteFrequency:r});const t=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),c=t.lockedSites||[],o=t.unlockedExceptions||[];if(!Array.isArray(c)||c.length===0||o.some(a=>n===a||n.endsWith("."+a)))return;const u=c.find(a=>a!=null&&a.is_locked?n===a.url||n.endsWith("."+a.url):!1);if(u){console.log(`[Background] Blocking ${n}`);const a=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(e.url)}&id=${u.id}`;chrome.tabs.update(e.tabId,{url:a})}}chrome.webNavigation.onBeforeNavigate.addListener(f);chrome.webNavigation.onHistoryStateUpdated.addListener(f);chrome.runtime.onInstalled.addListener(()=>{d(),setInterval(d,5e3)});setInterval(d,5e3);chrome.runtime.onMessage.addListener((e,n,s)=>{if(e.type==="SYNC_LOCKS")return d().then(()=>s({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const r=e.url,t=l(r);if(t)return chrome.storage.local.get("unlockedExceptions").then(async c=>{const o=c.unlockedExceptions||[];o.includes(t)||(o.push(t),await chrome.storage.local.set({unlockedExceptions:o})),s({success:!0})}),!0}if(e.type==="RELOCK_SITE"){const r=l(e.url);if(r)return chrome.storage.local.get("unlockedExceptions").then(async t=>{let c=t.unlockedExceptions||[];c=c.filter(o=>o!==r),await chrome.storage.local.set({unlockedExceptions:c}),s({success:!0})}),!0}});chrome.runtime.onMessageExternal.addListener((e,n,s)=>{if(e.type==="SYNC_LOCKS")return d().then(()=>s({success:!0})),!0});
