const l="http://127.0.0.1:4000/api";function u(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function c(){try{const r=(await chrome.storage.local.get("auth_token")).auth_token;if(!r)return;const t=await fetch(`${l}/locks`,{headers:{Authorization:`Bearer ${r}`}});if(t.ok){const a=await t.json();await chrome.storage.local.set({lockedSites:a.locks,lastSync:Date.now()}),console.log("[Background] Locks synced:",a.locks.length)}}catch(e){console.error("[Background] Sync failed:",e)}}async function h(e){try{const t=new URL(e).hostname;if(!t||t.startsWith("chrome")||t==="newtab"||t==="extensions")return;const n=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};n[t]=(n[t]||0)+1,await chrome.storage.local.set({websiteFrequency:n})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0)return;const r=e.url;if(r.startsWith(chrome.runtime.getURL("")))return;h(r);const{lockedSites:t}=await chrome.storage.local.get("lockedSites");if(!(!Array.isArray(t)||t.length===0))try{const n=new URL(r).hostname.toLowerCase(),s=t.find(o=>{if(!(o!=null&&o.is_locked))return!1;const i=u(o.url);return i?n.includes(i):!1});if(s){console.log(`[Background] Blocking ${n}`);const o=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(r)}&id=${s.id}`;chrome.tabs.update(e.tabId,{url:o})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed. Starting sync alarm."),c(),chrome.alarms.create("syncLocks",{periodInMinutes:5})});chrome.alarms.onAlarm.addListener(e=>{e.name==="syncLocks"&&c()});chrome.runtime.onMessage.addListener((e,r,t)=>{if(e.type==="SYNC_LOCKS")return c().then(()=>t({success:!0})),!0;e.type==="UNLOCK_SITE"&&(console.log("[Background] Unlocking site temporarily (User PIN verified)"),t({success:!0}))});
