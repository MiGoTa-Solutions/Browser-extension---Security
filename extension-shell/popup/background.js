const p="http://127.0.0.1:4000/api";function d(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function l(){try{const e=await chrome.storage.local.get(["auth_token","unlockedExceptions","lockedSites"]),c=e.auth_token;if(!c){u("?","#9ca3af");return}const t=await fetch(`${p}/locks`,{headers:{Authorization:`Bearer ${c}`}});if(t.status===401){console.warn("[Background] Auth Token Expired"),u("!","#ef4444");return}if(t.ok){const n=(await t.json()).locks.map(i=>({...i,url:d(i.url)}));let s=e.unlockedExceptions||[];const r=n.filter(i=>i.is_locked).map(i=>i.url),o=s.filter(i=>r.some(k=>i.includes(k))),h=e.lockedSites||[],g=JSON.stringify(n)!==JSON.stringify(h),f=JSON.stringify(o)!==JSON.stringify(s);(g||f)&&(await chrome.storage.local.set({lockedSites:n,unlockedExceptions:o,lastSync:Date.now()}),console.log(`[Background] Synced. Active Locks: ${n.length}`)),u("","")}}catch{u("ERR","#f59e0b")}}function u(e,c){chrome.action.setBadgeText({text:e}),c&&chrome.action.setBadgeBackgroundColor({color:c})}async function m(e){try{if(!e||e.startsWith("chrome")||e==="newtab"||e==="extensions")return;const t=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};t[e]=(t[e]||0)+1,await chrome.storage.local.set({websiteFrequency:t})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0)return;const c=e.url;if(c.startsWith(chrome.runtime.getURL("")))return;let t;try{t=new URL(c).hostname.toLowerCase()}catch{return}m(t);const a=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),n=a.lockedSites||[],s=a.unlockedExceptions||[];if(!(!Array.isArray(n)||n.length===0))try{if(s.some(o=>t===o||t.endsWith("."+o)))return;const r=n.find(o=>!(o!=null&&o.is_locked)||!o.url?!1:t===o.url||t.endsWith("."+o.url));if(r){console.log(`[Background] Blocking ${t}`);const o=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(c)}&id=${r.id}`;chrome.tabs.update(e.tabId,{url:o})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed."),l(),setInterval(l,5e3)});setInterval(l,5e3);chrome.runtime.onMessage.addListener((e,c,t)=>{if(e.type==="SYNC_LOCKS")return l().then(()=>t({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const a=e.url,n=d(a);if(n)return console.log(`[Background] Adding Exception: ${n}`),chrome.storage.local.get("unlockedExceptions").then(async s=>{try{const r=s.unlockedExceptions||[];r.includes(n)||(r.push(n),await chrome.storage.local.set({unlockedExceptions:r})),t({success:!0})}catch{t({success:!1})}}),!0}if(e.type==="RELOCK_SITE"){const a=d(e.url);if(a)return console.log(`[Background] Re-locking: ${a}`),chrome.storage.local.get("unlockedExceptions").then(async n=>{let s=n.unlockedExceptions||[];s=s.filter(r=>r!==a),await chrome.storage.local.set({unlockedExceptions:s}),t({success:!0})}),!0}});chrome.runtime.onMessageExternal.addListener((e,c,t)=>{if(e.type==="SYNC_LOCKS")return console.log("[Background] External Sync Request Received"),l().then(()=>t({success:!0})),!0});
