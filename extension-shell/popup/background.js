const g="http://127.0.0.1:4000/api";function d(t){if(!t)return null;try{return t.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function l(){try{const r=(await chrome.storage.local.get("auth_token")).auth_token;if(!r){i("?","#9ca3af");return}const e=await fetch(`${g}/locks`,{headers:{Authorization:`Bearer ${r}`}});if(e.status===401){console.warn("[Background] Auth Token Expired"),i("!","#ef4444");return}if(e.ok){const n=await e.json();await chrome.storage.local.set({lockedSites:n.locks,lastSync:Date.now()}),i("",""),console.log(`[Background] Locks synced: ${n.locks.length}`)}}catch{i("ERR","#f59e0b")}}function i(t,r){chrome.action.setBadgeText({text:t}),r&&chrome.action.setBadgeBackgroundColor({color:r})}async function f(t){try{const e=new URL(t).hostname;if(!e||e.startsWith("chrome")||e==="newtab"||e==="extensions")return;const c=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};c[e]=(c[e]||0)+1,await chrome.storage.local.set({websiteFrequency:c})}catch{}}chrome.webNavigation.onBeforeNavigate.addListener(async t=>{if(t.frameId!==0)return;const r=t.url;if(r.startsWith(chrome.runtime.getURL("")))return;f(r);const e=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),n=e.lockedSites||[],c=e.unlockedExceptions||[];if(!(!Array.isArray(n)||n.length===0))try{const o=new URL(r).hostname.toLowerCase();if(c.some(s=>o===s||o.endsWith("."+s))){console.log(`[Background] Allowing exception: ${o}`);return}const h=n.find(s=>{if(!(s!=null&&s.is_locked))return!1;const u=d(s.url);return u?o===u||o.endsWith("."+u):!1});if(h){console.log(`[Background] Blocking ${o}`);const s=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(r)}&id=${h.id}`;chrome.tabs.update(t.tabId,{url:s})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed."),l(),setInterval(l,5e3)});setInterval(l,5e3);chrome.runtime.onMessage.addListener((t,r,e)=>{if(t.type==="SYNC_LOCKS")return l().then(()=>e({success:!0})),!0;if(t.type==="UNLOCK_SITE"){const n=t.url,c=d(n);if(c)return console.log(`[Background] Adding Exception: ${c}`),chrome.storage.local.get("unlockedExceptions").then(async a=>{try{const o=a.unlockedExceptions||[];o.includes(c)||(o.push(c),await chrome.storage.local.set({unlockedExceptions:o})),e({success:!0})}catch(o){console.error("[Background] Storage Write Error:",o),e({success:!1,error:"Storage write failed"})}}),!0}if(t.type==="RELOCK_SITE"){const n=d(t.url);if(n)return console.log(`[Background] Re-locking: ${n}`),chrome.storage.local.get("unlockedExceptions").then(async c=>{try{let a=c.unlockedExceptions||[];a=a.filter(o=>o!==n),await chrome.storage.local.set({unlockedExceptions:a}),e({success:!0})}catch(a){console.error("[Background] Storage Write Error:",a),e({success:!1})}}),!0}});chrome.runtime.onMessageExternal.addListener((t,r,e)=>{if(t.type==="SYNC_LOCKS")return console.log("[Background] External Sync Request Received"),l().then(()=>e({success:!0})),!0});
