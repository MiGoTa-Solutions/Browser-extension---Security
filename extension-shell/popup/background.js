const s="http://localhost:4000/api";async function a(){try{const t=(await chrome.storage.local.get("auth_token")).auth_token;if(!t){console.log("[Background] No auth token found. Skipping sync.");return}const o=await fetch(`${s}/locks`,{headers:{Authorization:`Bearer ${t}`}});if(o.ok){const r=await o.json();await chrome.storage.local.set({lockedSites:r.locks,lastSync:Date.now()}),console.log("[Background] Locks synced:",r.locks.length)}else console.error("[Background] Sync failed status:",o.status)}catch(e){console.error("[Background] Sync failed:",e)}}chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(e.frameId!==0||e.url.startsWith(chrome.runtime.getURL("")))return;const{lockedSites:t}=await chrome.storage.local.get("lockedSites");if(!(!Array.isArray(t)||t.length===0))try{const r=new URL(e.url).hostname.toLowerCase(),c=t.find(n=>n.is_locked&&r.includes(n.url.toLowerCase()));if(c){console.log(`[Background] Blocking ${e.url} due to lock: ${c.url}`);const n=chrome.runtime.getURL("lock.html")+`?url=${encodeURIComponent(e.url)}&id=${c.id}`;chrome.tabs.update(e.tabId,{url:n})}}catch{}});chrome.runtime.onInstalled.addListener(()=>{console.log("[Background] Installed. Starting sync alarm."),a(),chrome.alarms.create("syncLocks",{periodInMinutes:5})});chrome.alarms.onAlarm.addListener(e=>{e.name==="syncLocks"&&a()});chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type==="SYNC_LOCKS")return a().then(()=>o({success:!0})),!0;e.type==="UNLOCK_SITE"&&(console.log("Unlocking site temporarily"),o({success:!0}))});
