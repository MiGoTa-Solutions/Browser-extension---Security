const k="http://127.0.0.1:4000/api";function l(e){if(!e)return null;try{return e.replace(/^(https?:\/\/)?(www\.)?/,"").split("/")[0].toLowerCase()}catch{return null}}async function E(e,o){try{const s=await chrome.tabs.query({});for(const r of s){if(!r.id||!r.url||r.url.startsWith("chrome"))continue;const t=l(r.url);if(!t||o&&o.some(n=>t===n||t.endsWith("."+n)))continue;const c=e.find(n=>n.is_locked?t===n.url||t.endsWith("."+n.url):!1);if(c){console.log(`[Background] Force-locking active tab: ${t}`);const n=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(r.url)}&id=${c.id}`;chrome.tabs.update(r.id,{url:n})}}}catch{}}async function d(){try{const e=await chrome.storage.local.get(["auth_token","unlockedExceptions","lockedSites","exceptionExpiry"]),o=e.auth_token;if(!o){f("?","#9ca3af");return}const s=await fetch(`${k}/locks`,{headers:{Authorization:`Bearer ${o}`}});if(s.status===401){f("!","#ef4444");return}if(s.ok){const t=(await s.json()).locks.map(i=>({...i,url:l(i.url)})),c=Date.now(),n=e.exceptionExpiry||{};let u=Array.isArray(e.unlockedExceptions)?e.unlockedExceptions:[];const a=u.filter(i=>{const h=n[i];return h?h>c:!0}),x=t.filter(i=>i.is_locked).map(i=>i.url),p=a.filter(i=>x.some(h=>i.includes(h))),y={};p.forEach(i=>{n[i]&&(y[i]=n[i])});const m=e.lockedSites||[];(JSON.stringify(t)!==JSON.stringify(m)||JSON.stringify(p)!==JSON.stringify(u))&&(await chrome.storage.local.set({lockedSites:t,unlockedExceptions:p,exceptionExpiry:y,lastSync:Date.now()}),console.log(`[Background] Synced. Active Locks: ${t.length}`)),E(t,p),f("","")}}catch{f("ERR","#f59e0b")}}function f(e,o){chrome.action.setBadgeText({text:e}),o&&chrome.action.setBadgeBackgroundColor({color:o})}async function g(e){if(e.frameId!==0||e.url.startsWith(chrome.runtime.getURL("")))return;const o=l(e.url);if(!o)return;const r=(await chrome.storage.local.get(["websiteFrequency"])).websiteFrequency||{};r[o]=(r[o]||0)+1,await chrome.storage.local.set({websiteFrequency:r});const t=await chrome.storage.local.get(["lockedSites","unlockedExceptions"]),c=t.lockedSites||[],n=Array.isArray(t.unlockedExceptions)?t.unlockedExceptions:[];if(!Array.isArray(c)||c.length===0||n.some(a=>o===a||o.endsWith("."+a)))return;const u=c.find(a=>a!=null&&a.is_locked?o===a.url||o.endsWith("."+a.url):!1);if(u){console.log(`[Background] Blocking ${o}`);const a=chrome.runtime.getURL("popup/lock.html")+`?url=${encodeURIComponent(e.url)}&id=${u.id}`;chrome.tabs.update(e.tabId,{url:a})}}chrome.webNavigation.onBeforeNavigate.addListener(g);chrome.webNavigation.onHistoryStateUpdated.addListener(g);chrome.runtime.onInstalled.addListener(()=>{d(),setInterval(d,5e3)});setInterval(d,5e3);chrome.runtime.onMessage.addListener((e,o,s)=>{if(e.type==="SYNC_LOCKS")return d().then(()=>s({success:!0})),!0;if(e.type==="UNLOCK_SITE"){const r=e.url,t=l(r);if(t)return console.log(`[Background] Adding Exception: ${t}`),chrome.storage.local.get(["unlockedExceptions","exceptionExpiry"]).then(async c=>{const n=Array.isArray(c.unlockedExceptions)?c.unlockedExceptions:[],u=c.exceptionExpiry||{};n.includes(t)||n.push(t),u[t]=Date.now()+18e5,await chrome.storage.local.set({unlockedExceptions:n,exceptionExpiry:u}),s({success:!0})}),!0}if(e.type==="RELOCK_SITE"){const r=l(e.url);if(r)return chrome.storage.local.get(["unlockedExceptions","exceptionExpiry"]).then(async t=>{let c=Array.isArray(t.unlockedExceptions)?t.unlockedExceptions:[],n=t.exceptionExpiry||{};c=c.filter(u=>u!==r),delete n[r],await chrome.storage.local.set({unlockedExceptions:c,exceptionExpiry:n}),s({success:!0})}),!0}});chrome.runtime.onMessageExternal.addListener((e,o,s)=>{if(e.type==="SYNC_LOCKS")return d().then(()=>s({success:!0})),!0});
